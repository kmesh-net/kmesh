apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kmesh-deploy
  labels:
    app: kmesh
spec:
  selector:
    matchLabels:
      app: kmesh
  template:
     metadata:
       labels:
         app: kmesh
     spec:
       volumes:
         - name: mnt
           hostPath:
             path: /mnt
         - name: sys-fs-bpf
           hostPath:
             path: /sys/fs/bpf
         - name: lib-modules
           hostPath:
             path: /lib/modules
         - name: kube-config-path
           hostPath:
             path: /root/.kube
         - name: cni
           hostPath:
             path: /etc/cni/net.d
         - name: kmesh-cniplugin
           hostPath:
             path: /opt/cni/bin
       containers:
         - name: kmesh
           image: kmesh:latest
           imagePullPolicy: IfNotPresent
           command: ["/bin/sh", "-c"]
           args: ["./start_kmesh.sh -enable-kmesh -enable-ads=true"]
           securityContext:
             privileged: true
             capabilities:
               add: ["all"]
           ports:
           - containerPort: 6789
             hostPort: 6789
           env:
           - name: MESH_CONTROLLER
             value: istio-system:istiod
           - name: BPF_LOG_SIZE
             value: "12800"
           volumeMounts:
           - name: mnt
             mountPath: /mnt
             readOnly: false
           - name: sys-fs-bpf
             mountPath: /sys/fs/bpf
             readOnly: false
           - name: lib-modules
             mountPath: /lib/modules
             readOnly: false
           - name: kube-config-path
             mountPath: /root/.kube
             readOnly: true
           - name: cni # cni conflist file
             mountPath: /etc/cni/net.d
             readOnly: false
           - name: kmesh-cniplugin # k8s default cni path
             mountPath: /opt/cni/bin
             readOnly: false
           resources:
             limits:
               memory: "200Mi"
               cpu: "1"
