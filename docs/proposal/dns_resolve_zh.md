---
title: ��̡������Եı���
authors:
- "@zhxuzhonghu"
reviewers:
- 
approvers:
- 


creation-date: 2024-05-08

---

## �ڼ�Ⱥ��������֧�� DNS ����

<!--
�������� KEP �ı��⡣���ּ�̡��򵥺������ԡ�һ���õı�����԰������� KEP �����ݣ�����Ӧ�ñ���Ϊ�κ�����һ���֡�
-->

### ժҪ

<!--
���ڶ������ɸ����������û�Ϊ���ĵ��ĵ����緢��˵���򿪷�·��ͼ���ǳ���Ҫ��
һ���õ�ժҪ����������һ������ĳ��ȡ�
-->

Envoy ֧����಻ͬ�ļ�Ⱥ���ͣ����� `Strict DNS`��`Logical DNS`�����ǣ����� Kmesh ���ں���ʹ�� ebpf ��������ǰ Kmesh ��֧���κ� DNS ���͵ļ�Ⱥ������ƥ����Щ��Ⱥ������������������

������᰸�У��ҽ���Ľ� Kmesh ��֧�� DNS ���͵ļ�Ⱥ���������ǾͿ���֧���������͵ļ�Ⱥ��

### ����

<!--
����������ȷ�г� KEP �Ķ�����Ŀ��ͷ�Ŀ�ꡣ����Ϊʲô���ĺ���Ҫ�Լ����û��ĺô���
-->

�� istio �У�[�ⲿ���Ʒ���](https://kubernetes.io/docs/concepts/services-networking/service/#externalname) �� DNS �������͵� [ServiceEntry](https://istio.io/latest/docs/reference/config/networking/service-entry/#ServiceEntry-Resolution) ���㷺ʹ�á��������������ã�istiod �����ɹ����� DNS ���ͼ�Ⱥ��

�ܶ��˶��������ַ���Kmesh ����֧�����������������޷�Ǩ�Ƶ�����

�������Ǵ���һ��������ʾ�� ServiceEntry��

```yaml
apiVersion: networking.istio.io/v1
kind: ServiceEntry
metadata:
  name: se
  namespace: default
spec:
  hosts:
  - news.google.com
  ports:
  - name: port1
    number: 80
    protocol: HTTP
  resolution: DNS
```

��������������ʾ�ļ�Ⱥ��

```json
{
    "name": "outbound|80||news.google.com",
    "type": "STRICT_DNS",
    "connectTimeout": "10s",
    "lbPolicy": "LEAST_REQUEST",
    "loadAssignment": {
        "clusterName": "outbound|80||news.google.com",
        "endpoints": [
            {
                "locality": {},
                "lbEndpoints": [
                    {
                        "endpoint": {
                            "address": {
                                "socketAddress": {
                                    "address": "news.google.com",
                                    "portValue": 80
                                }
                            }
                        },
                        "metadata": {
                            "filterMetadata": {
                                "istio": {
                                    "workload": ";;;;"
                                }
                            }
                        },
                        "loadBalancingWeight": 1
                    }
                ],
                "loadBalancingWeight": 1
            }
        ]
    },
    "dnsRefreshRate": "60s",
    "respectDnsTtl": true,
    "dnsLookupFamily": "V4_ONLY",
    "commonLbConfig": {
        "localityWeightedLbConfig": {}
    },
    ...
}
```

#### Ŀ��

<!--
�г� KEP �ľ���Ŀ�ꡣ����ͼʵ��ʲô���������֪�����Ѿ��ɹ���
-->

���ں������������Ҫ��

- ֧�� DNS �������͵ķ��������������ؿ��Է��� DNS ����

#### ��Ŀ��

<!--
�� KEP �ķ�Χ֮����ʲô���г���Ŀ�������ڼ������۲�ȡ�ý�չ��
-->

- ��Ҫ����Ӧ�ó��� DNS ��������

- ��ҪΪӦ�ó����ṩ�ڵ㱾�� DNS ���������ⲻ�Ǳ��᰸��Ŀ�ꡣ

- ���� istiod ��֧�ֹ������� DNS ������Kmesh �ڹ�������ģʽ��Ҳ��֧������

### �᰸

<!--
��������ǽ���ϸ�����᰸��ʵ�����ݡ���Ӧ�����㹻��ϸ�ڣ��Ա������߿���׼ȷ���������������ݣ�����Ӧ���� API ��ƻ�ʵ��֮������ݡ�ʲô�������Ľ����������κ����ɹ�������ġ����ϸ�ڡ���������������ϸ�ڡ�
-->

����Ӧ��ʵ��һ���µ������ִ�� DNS ��������Ϊ `dns resolver`��DNS ������������Ӧ����Ҫ����

- DNS ���� DNS ���ͼ�Ⱥ�еĶ˵�

- �������¼�� DNS ���Ʊ���

- ����ˢ�� DNS ���Ʊ����ѭ `dnsRefreshRate` �� DNS ttl��

���ǻ�Ӧ���ṩһ�ַ������� ebpf ��Ⱥ������������� DNS ���Ʊ��

### ���ϸ��

<!--
����Ӧ�����㹻����Ϣ���Ա����������ĸ��ĵľ���ϸ�ڡ�����ܰ��� API �淶�����ܲ������Ǳ���ģ���������Ƭ�Ρ���������ʵʩ�����᰸���κ����壬���ڴ˴��������ۡ�
-->

�����ϣ����ǿ��Կ������ں˻��û��ռ���ʵ�� DNS �����������ǵ������ԣ��ҽ��������� Kmesh �ػ�������ִ�д˲�����

![DNS Resolver Arch](./pics/dns-resolver.svg)

`DNS Resolver` �� ads ģʽ��������˽������� ads ʱ���С����� ads ������Э�����������������ǣ�

- ads ����������� istiod ���� xDS�������յ����� DNS ���͵ļ�Ⱥʱ������ͨ��ͨ��֪ͨ `DNS Resolver`��

- `DNS Resolver` ����ʹ�� Kmesh �ػ������е� DNS ���ý��� DNS ������

- ������`DNS Resolver` ��ͨ������ bpf ��ϣӳ�����������Ʊ��

- ��Ҫ���ǵ�δ��ͼ��������`DNS Resolver` Ӧͨ����ѭ `dnsRefreshRate` �� ttl���Խ϶���Ϊ׼������ˢ�� DNS ��ַ��

���� DNS ������package `github.com/miekg/dns` �ṩ�˺ܺõĿ⣬������ִ�� DNS ������ DNS ������Ȼ���ﲻ֧�� DNS ���񣬵�����Ӧ��ѡ��һ��ȷʵ�������ֹ��ܵİ����Ա㽫��������չ��������ʹ�ô˰�����һ��ԭ���ǣ�coredns Ҳʹ��������������������б��㷺ʹ�á�

����Ӧ��ȷ��û�� DNS ���ƿ���й©����Ⱥ�ڷ���ɾ����ɾ���Ǻܳ����ġ������� Kmesh �У�����ʹ�� Stow xDS��ÿ���յ� CDS ��Ӧʱ����������������е����м�Ⱥ��ads �������������ǣ���Ӧ��Ȼ�����Ǵ洢���û��ռ仺��� bpf ӳ���С����ǿ����� ads ������Ҳִ�� `Stow` ֪ͨ���������˵���� ads �������������м�Ⱥʱ����Ӧ�ý�������Ҫ������ DNS �������͵� `DNS Resolver`��

����֪ͨ��ͨ�� golang ͨ�����еģ����Ч�ʺܸߣ�`Stow` Ӧ�ÿ��������������� `DNS Resolver` �У���Ӧ�ô���һ�� map ����¼����Ҫ���������� DNS ��������ˣ�ÿ��֪ͨ����Ӧ���ܹ���������ӡ���ɾ����δ���ĵ� DNS ������

��������ӵ���������Ӧ�������������ǲ������д�� DNS ���Ʊ������������͵�ˢ�¶����С�������ɾ������������Ӧ�ôӱ��ػ���Ͷ���ˢ�¶�����ɾ�����ǡ�����δ���ĵ�������������ʲô��������

#### ���Լƻ�

<!--
**ע�⣺** *����Է����汾֮ǰ����Ҫ��*
��Ϊ����ǿ�����ƶ����Լƻ�ʱ���뿼���������
- ���˵�Ԫ����֮�⣬�Ƿ���� e2e �ͼ��ɲ��ԣ�
- ����ڸ���״̬�����������һ����в��ԣ�
����������в���������ֻ�����������Լ��ɡ��κ���ʵ���б���Ϊ�Ǽ��ֵ����飬�Լ��κ��ر����Բ��Ե����飬��Ӧ�ñ��������
-->

### �������

<!--
������������Щ�����������Լ�Ϊʲô���ų������ǣ���Щ����Ҫ���᰸������ϸ����Ӧ�ð����㹻����Ϣ���������뷨�Լ�Ϊʲô���ǲ��ɽ��ܵġ�
-->

<!--
ע�⣺���� kubernetes ��ǿ�᰸ģ��ļ򻯰汾��
https://github.com/kubernetes/enhancements/tree/3317d4cb548c396a430d1c1ac6625226018adf6a/keps/NNNN-kep-template
-->

