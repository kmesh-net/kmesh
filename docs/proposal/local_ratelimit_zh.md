---
title: ������������
authors:
- "yuanqijing"
reviewers:
- "@tacslon"
- "@hzxuzhonghu"
- "@nlwcy"
- TBD
approvers:
- "@robot"
- TBD

creation-date: 2024-09-19

---

## ֧�ֱ�����������

### ժҪ
Envoy ֧�ֱ����������ƣ��� Kmesh Ŀǰ��֧�֡����᰸ּ���� Kmesh ��ӱ����������ƣ��ص���ÿ�����ӵ��������ơ�

### ����
��������οͻ�����һ�����η�������������ʱ��Ϊÿ���ͻ��������ʵ����۶ϲ��Ծ�����ս�ԡ��۶ϲ�����Ч�ش���ͻ�����ӡ��� Istio �У�EnvoyFilters �ڹ��������д�������֮ǰ����Ӧ���������ƣ��Ӷ��ṩ���õĿ��ơ�

Envoy ֧�������������ƻ��ƣ�
* **������������**: Envoy ���ÿ�������ӵ��������Ʒ���ʹ�����õ���������ÿ�����������
* **HTTP ��������**: Envoy ���ÿ�� HTTP ������������Ʒ��񣬻���·�����ã����ƶ����κͼ�Ⱥ�������
* **����������������**: ǿ��ִ����Դʹ����ʱ�����

Envoy ֧�������������Ʋ���ģʽ��
* **ȫ����������**: ���ͻ��˷����µ���������ʱ��Envoy �����������е��������ƹ�������Ȼ�󣬸ù��������ⲿȫ���������Ʒ���ͨ�ţ���ȷ���Ƿ���������ӡ�
* **������������**: Envoy ֱ��������ƽ���д������������߼��������ⲿ�������Ʒ���

���� Kmesh �ǻ��� eBPF ������ƽ�棬��֧���ⲿ�������ʵ��ȫ�����������ǲ����еġ���ˣ����᰸��������ӱ����������ƣ��ر���ÿ�����ӵ��������ƣ��Դ���ͻ�����Ӳ���Ч������ء�

**Ŀ��**:
* �� Kmesh ��ӱ�������������֧��ÿ�����ӵ��������ơ�

**��Ŀ��**:
* �� Kmesh ���ȫ���������ơ�
* ʵ�� HTTP �������ƻ���������������ơ�

### ���ϸ��
#### �� Istio �е�����
Ҫ�� Envoy �����ñ����������ƣ���ʹ�� EnvoyFilter �� `local_ratelimit` ���������뵽�������Ĺ��������С�������һ�� YAML ����ʾ����
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
  namespace: istio-system
spec:
  configPatches:
    - applyTo: NETWORK_FILTER
      match:
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.tcp_proxy
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.local_ratelimit.v3.LocalRateLimit
            stat_prefix: local_rate_limit
            token_bucket:
              max_tokens: 4
              tokens_per_fill: 4
              fill_interval: 60s
```

��������ý� local_ratelimit ���������뵽�������Ĺ��������е� tcp_proxy ������֮ǰ��

�� xds �У�local_ratelimit �������������£�
```json
{
  "stat_prefix": "local_rate_limit",
  "token_bucket": {
    "max_tokens": 4,
    "tokens_per_fill": 4,
    "fill_interval": "60s"
  }
}
```
token_bucket ���ö��������ǿ��ִ���������ơ�`max_tokens` ָ�� bucket �������ɵ����������������ͻ��������`tokens_per_fill` ȷ����ÿ���������ӵ� bucket ����������`fill_interval` �����˲������Ƶ�ʱ������������ʾ���У�bucket ���������� 4 �����ƣ�ÿ 60 ����� 4 �����ơ�����������ÿ������� 4 �������ӡ�

#### �������������߼�
����ͼ��ʾ��Kmesh �е�ÿ�����ӵ��������ƹ������£�
1. **���ӷ���**: �ͻ��˷����µ���������
2. **����������**: �������󵽴�������� hook �㡣��ִ�й�������֮ǰ��Ӧ�����������߼���
3. **�������ƾ���**: ������������¼��ʷ���������洢�� ebpf ��ϣӳ���У����������� `token_bucket` ���ý��бȽϡ����ڴ˱Ƚϣ���ȷ����������Ǿܾ������ӡ�

![������������](./pics/local_ratelimit.svg)

�� filter_chain_manager �У�����ͨ������һ���������������������߼����ú����������ӳ��Լ��͸�������Ͱ��
1. **������ƥ��**: �ú���������֤ local_ratelimit �������Ƿ�����ڹ��������С���������ڣ����������Ӽ������ж��������������ơ�
2. **���ü���**: ����ƥ��Ĺ������м��� rate_limit �� token_bucket ���á�
3. **�������ƾ���**: ����������ʹ�ÿͻ��˵ĵ�ַ��Ϊ��Կ��������Ӧ������Ͱ���������ϴ����Ʋ�������������ʱ�䣬��������ӵ� bucket �У�ֱ���ﵽ���������������ƿ��ã�������һ���������������ӣ��������ӽ����ܾ���

���������߼���ѭ����Ͱ�㷨�������������ʣ�
1. **��ʼ��**: �������µĿͻ��˵�ַʱ����ʹ����������� (max_tokens) ��ʼ������Ͱ��
2. **���Ʋ���**: ���ƻᶨ����ӵ� bucket �У������ fill_interval ���壬ȷ�� bucket ������ max_tokens��
3. **���Ӵ���**: ������ƿ��ã�������һ�����ƣ����������ӡ����û�����ƿ��ã������ӽ����ܾ���

![����Ͱ](./pics/token_bucket_algorithm.png)

