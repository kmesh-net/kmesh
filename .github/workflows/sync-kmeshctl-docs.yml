name: Sync kmeshctl Docs to Website

on:
  push:
    branches:
      - main
    paths:
      - docs/ctl/**
      - .github/workflows/sync-kmeshctl-docs.yml

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: 🧭 Checkout website repository
        uses: actions/checkout@v4
        with:
          repository: kmesh-net/website
          token: ${{ secrets.WEBSITE_PAT }}
          path: website
          fetch-depth: 1

      - name: 🧭 Checkout kmesh repository
        uses: actions/checkout@v4
        with:
          repository: kmesh-net/kmesh
          token: ${{ secrets.GITHUB_TOKEN }}
          path: kmesh
          fetch-depth: 1

      - name: 🔁 Sync kmeshctl Docs Using rsync
        run: |
          set -e

          KMESH_CTL_DIR="/github/workspace/kmesh/docs/ctl"
          WEBSITE_KMESHCTL_DIR="/github/workspace/website/docs/kmeshctl"

          echo "🔍 Source directory: $KMESH_CTL_DIR"
          echo "🎯 Target directory: $WEBSITE_KMESHCTL_DIR"

          # ✅ Check if source directory exists
          if [ ! -d "$KMESH_CTL_DIR" ]; then
            echo "❌ ERROR: Source directory $KMESH_CTL_DIR does not exist!"
            ls -la /github/workspace/kmesh/docs/
            exit 1
          fi

          # 📁 Create target directory if not exists
          if [ ! -d "$WEBSITE_KMESHCTL_DIR" ]; then
            echo "📁 Creating $WEBSITE_KMESHCTL_DIR..."
            mkdir -p "$WEBSITE_KMESHCTL_DIR"
          fi

          # 🔍 LOG SOURCE FILES before sync
          echo "📄 Files in SOURCE ($KMESH_CTL_DIR) before sync:"
          if [ -d "$KMESH_CTL_DIR" ]; then
            find "$KMESH_CTL_DIR" -type f | sort || echo "No files found"
          else
            echo "❌ Source directory missing!"
            exit 1
          fi

          # 🔍 LOG TARGET FILES before sync
          echo "📄 Files in TARGET ($WEBSITE_KMESHCTL_DIR) before sync:"
          if [ -d "$WEBSITE_KMESHCTL_DIR" ]; then
            find "$WEBSITE_KMESHCTL_DIR" -type f | sort || echo "No files found"
          else
            echo "⚠️ Target directory empty or missing"
          fi

          # 🔄 Run rsync to sync files with checksum for content changes
          echo "🔄 Syncing files with rsync (using checksum for content comparison)..."
          rsync -avc --delete --exclude='.git' --exclude='.*' "$KMESH_CTL_DIR/" "$WEBSITE_KMESHCTL_DIR/" || {
            echo "❌ ERROR: rsync synchronization failed!"
            exit 1
          }

          # 🔍 LOG TARGET FILES after sync
          echo "📄 Files in TARGET ($WEBSITE_KMESHCTL_DIR) after sync:"
          if [ -d "$WEBSITE_KMESHCTL_DIR" ]; then
            find "$WEBSITE_KMESHCTL_DIR" -type f | sort || echo "No files copied"
          else
            echo "❌ ERROR: Target directory not created!"
            exit 1
          fi

          # 🔀 Go into website repo
          cd /github/workspace/website

          # 📥 Refresh Git index and stage all changes
          echo "🔍 Refreshing Git index and staging changes in docs/kmeshctl/..."
          git reset --hard
          git add -A docs/kmeshctl/

          # 🔍 Show what was staged
          echo "📌 Staged changes:"
          git diff --cached --name-only || echo "No changes staged"

          # ✅ Check if there are any changes
          if git diff --cached --quiet; then
            echo "✅ No changes detected. All docs are up to date."
            exit 0
          else
            echo "✨ Changes detected. Creating commit..."

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git commit -m 'docs: sync kmeshctl docs from kmesh-net/kmesh' || {
              echo "❌ ERROR: Commit failed!"
              git status
              exit 1
            }

            echo "📤 Pushing changes to kmesh-net/website..."
            git push origin main || {
              echo "❌ ERROR: Push failed!"
              git status
              exit 1
            }

            echo "🎉 Sync completed successfully!"
          fi