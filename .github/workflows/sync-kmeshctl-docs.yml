name: Sync kmeshctl Docs to Website

on:
  push:
    branches:
      - main
    paths:
      - docs/ctl/**
      - .github/workflows/sync-kmeshctl-docs.yml

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout website repository
        uses: actions/checkout@v4
        with:
          repository: kmesh-net/website
          token: ${{ secrets.WEBSITE_PAT }}
          path: website
          fetch-depth: 1

      - name: ğŸ§­ Checkout kmesh repository
        uses: actions/checkout@v4
        with:
          repository: kmesh-net/kmesh
          token: ${{ secrets.GITHUB_TOKEN }}
          path: kmesh
          fetch-depth: 1

      - name: ğŸ” Sync kmeshctl Docs Using rsync
        run: |
          set -e

          KMESH_CTL_DIR="/github/workspace/kmesh/docs/ctl"
          WEBSITE_KMESHCTL_DIR="/github/workspace/website/docs/kmeshctl"

          echo "ğŸ” Source directory: $KMESH_CTL_DIR"
          echo "ğŸ¯ Target directory: $WEBSITE_KMESHCTL_DIR"

          # âœ… Check if source directory exists
          if [ ! -d "$KMESH_CTL_DIR" ]; then
            echo "âŒ ERROR: Source directory $KMESH_CTL_DIR does not exist!"
            ls -la /github/workspace/kmesh/docs/
            exit 1
          fi

          # ğŸ“ Create target directory if not exists
          if [ ! -d "$WEBSITE_KMESHCTL_DIR" ]; then
            echo "ğŸ“ Creating $WEBSITE_KMESHCTL_DIR..."
            mkdir -p "$WEBSITE_KMESHCTL_DIR"
          fi

          # ğŸ” LOG SOURCE FILES before sync
          echo "ğŸ“„ Files in SOURCE ($KMESH_CTL_DIR) before sync:"
          if [ -d "$KMESH_CTL_DIR" ]; then
            find "$KMESH_CTL_DIR" -type f | sort || echo "No files found"
          else
            echo "âŒ Source directory missing!"
            exit 1
          fi

          # ğŸ” LOG TARGET FILES before sync
          echo "ğŸ“„ Files in TARGET ($WEBSITE_KMESHCTL_DIR) before sync:"
          if [ -d "$WEBSITE_KMESHCTL_DIR" ]; then
            find "$WEBSITE_KMESHCTL_DIR" -type f | sort || echo "No files found"
          else
            echo "âš ï¸ Target directory empty or missing"
          fi

          # ğŸ”„ Run rsync to sync files with checksum for content changes
          echo "ğŸ”„ Syncing files with rsync (using checksum for content comparison)..."
          rsync -avc --delete --exclude='.git' --exclude='.*' "$KMESH_CTL_DIR/" "$WEBSITE_KMESHCTL_DIR/" || {
            echo "âŒ ERROR: rsync synchronization failed!"
            exit 1
          }

          # ğŸ” LOG TARGET FILES after sync
          echo "ğŸ“„ Files in TARGET ($WEBSITE_KMESHCTL_DIR) after sync:"
          if [ -d "$WEBSITE_KMESHCTL_DIR" ]; then
            find "$WEBSITE_KMESHCTL_DIR" -type f | sort || echo "No files copied"
          else
            echo "âŒ ERROR: Target directory not created!"
            exit 1
          fi

          # ğŸ”€ Go into website repo
          cd /github/workspace/website

          # ğŸ“¥ Refresh Git index and stage all changes
          echo "ğŸ” Refreshing Git index and staging changes in docs/kmeshctl/..."
          git reset --hard
          git add -A docs/kmeshctl/

          # ğŸ” Show what was staged
          echo "ğŸ“Œ Staged changes:"
          git diff --cached --name-only || echo "No changes staged"

          # âœ… Check if there are any changes
          if git diff --cached --quiet; then
            echo "âœ… No changes detected. All docs are up to date."
            exit 0
          else
            echo "âœ¨ Changes detected. Creating commit..."

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git commit -m 'docs: sync kmeshctl docs from kmesh-net/kmesh' || {
              echo "âŒ ERROR: Commit failed!"
              git status
              exit 1
            }

            echo "ğŸ“¤ Pushing changes to kmesh-net/website..."
            git push origin main || {
              echo "âŒ ERROR: Push failed!"
              git status
              exit 1
            }

            echo "ğŸ‰ Sync completed successfully!"
          fi